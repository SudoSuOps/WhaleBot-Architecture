import React, { useState } from 'react';
import { TrendingUp, TrendingDown, Zap, X, AlertTriangle, Wallet, Target } from 'lucide-react';
import { WHALE_CONFIG } from '../constants';

interface TradeExecutionProps { currentPrice: number; selectedAsset: string; onPlaceOrder: (type: 'LONG' | 'SHORT', size: number, leverage: number, asset: string) => void; }

const TradeExecution: React.FC<TradeExecutionProps> = ({ currentPrice, selectedAsset, onPlaceOrder }) => {
  const [size, setSize] = useState<number>(5000); const [leverage, setLeverage] = useState<number>(10); const [isModalOpen, setIsModalOpen] = useState(false); const [pendingSide, setPendingSide] = useState<'LONG' | 'SHORT' | null>(null); const [lockedAsset, setLockedAsset] = useState<string>(selectedAsset);
  const maxSize = WHALE_CONFIG.sizing.maxLongSize;

  const openModal = (side: 'LONG' | 'SHORT') => { setPendingSide(side); setLockedAsset(selectedAsset); setIsModalOpen(true); };
  const closeModal = () => { setIsModalOpen(false); setPendingSide(null); };
  const handleExecute = () => { if (pendingSide) { onPlaceOrder(pendingSide, size, leverage, lockedAsset); closeModal(); } };
  
  const marginRequired = size / leverage; const liquidationPrice = pendingSide === 'LONG' ? currentPrice * (1 - (1 / leverage) * 0.9) : currentPrice * (1 + (1 / leverage) * 0.9);

  return (
    <>
      <div className="bg-whale-800 border border-whale-700 rounded-xl p-6 shadow-lg relative overflow-hidden group"><div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none group-hover:opacity-10 transition-opacity"><Zap size={120} /></div><div className="flex items-center gap-2 mb-6 border-b border-whale-700 pb-4 relative z-10"><Zap className="text-trenchGold-500" size={20} /><h3 className="font-bold text-white">Quick Execution</h3><span className="ml-auto text-xs font-mono text-slate-500 bg-whale-900 px-2 py-1 rounded border border-whale-700">{selectedAsset}-PERP</span></div><div className="space-y-6 relative z-10"><div className="bg-whale-900/50 p-4 rounded border border-whale-700 text-center"><p className="text-xs text-slate-500 uppercase tracking-widest mb-1">Market Price</p><p className="text-2xl font-mono font-bold text-white tracking-tight">${currentPrice.toLocaleString(undefined, {minimumFractionDigits: 2})}</p></div><div className="grid grid-cols-2 gap-4"><button onClick={() => openModal('LONG')} className="flex flex-col items-center justify-center p-6 rounded-xl bg-gradient-to-br from-emerald-600 to-emerald-900 border border-emerald-500/50 hover:from-emerald-500 hover:to-emerald-800 transition-all active:scale-95 shadow-[0_0_20px_rgba(16,185,129,0.2)] group"><span className="flex items-center gap-2 font-black text-white text-xl tracking-wider">BUY <TrendingUp size={24} className="group-hover:-translate-y-1 transition-transform"/></span><span className="text-[10px] text-emerald-200 uppercase tracking-widest mt-1 opacity-80">Open Long</span></button><button onClick={() => openModal('SHORT')} className="flex flex-col items-center justify-center p-6 rounded-xl bg-gradient-to-br from-rose-600 to-rose-900 border border-rose-500/50 hover:from-rose-500 hover:to-rose-800 transition-all active:scale-95 shadow-[0_0_20px_rgba(244,63,94,0.2)] group"><span className="flex items-center gap-2 font-black text-white text-xl tracking-wider">SELL <TrendingDown size={24} className="group-hover:translate-y-1 transition-transform"/></span><span className="text-[10px] text-rose-200 uppercase tracking-widest mt-1 opacity-80">Open Short</span></button></div><div className="text-center"><p className="text-[10px] text-slate-500">1-Click Execution Disabled. Confirmation required.</p></div></div></div>
      {isModalOpen && pendingSide && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className={`w-full max-w-md bg-whale-900 border-2 rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden animate-in zoom-in-95 duration-200 ${pendingSide === 'LONG' ? 'border-emerald-500/50 shadow-emerald-900/20' : 'border-rose-500/50 shadow-rose-900/20'}`}><div className={`p-4 flex justify-between items-center ${pendingSide === 'LONG' ? 'bg-emerald-900/20' : 'bg-rose-900/20'}`}><div className="flex items-center gap-2">{pendingSide === 'LONG' ? <TrendingUp className="text-emerald-400" /> : <TrendingDown className="text-rose-400" />}<h3 className="text-xl font-bold text-white">Configure {pendingSide === 'LONG' ? 'Buy' : 'Sell'} {lockedAsset}</h3></div><button onClick={closeModal} className="text-slate-400 hover:text-white transition-colors"><X size={24} /></button></div><div className="p-6 space-y-6"><div><div className="flex justify-between text-sm mb-2"><span className="text-slate-400 flex items-center gap-1"><Wallet size={14}/> Position Size</span><span className="text-white font-mono font-bold text-lg">${size.toLocaleString()}</span></div><input type="range" min="1000" max={maxSize} step="1000" value={size} onChange={(e) => setSize(Number(e.target.value))} className={`w-full h-2 bg-whale-800 rounded-lg appearance-none cursor-pointer ${pendingSide === 'LONG' ? 'accent-emerald-500' : 'accent-rose-500'}`}/><div className="flex justify-between mt-2"><button onClick={() => setSize(1000)} className="text-[10px] bg-whale-800 px-2 py-1 rounded text-slate-400 hover:text-white">Min</button><button onClick={() => setSize(maxSize / 2)} className="text-[10px] bg-whale-800 px-2 py-1 rounded text-slate-400 hover:text-white">50%</button><button onClick={() => setSize(maxSize)} className="text-[10px] bg-whale-800 px-2 py-1 rounded text-slate-400 hover:text-white">Max</button></div></div><div><div className="flex justify-between text-sm mb-2"><span className="text-slate-400 flex items-center gap-1"><Target size={14}/> Leverage</span><span className="text-diamond-500 font-mono font-bold text-lg">{leverage}x</span></div><input type="range" min="1" max="50" step="1" value={leverage} onChange={(e) => setLeverage(Number(e.target.value))} className="w-full h-2 bg-whale-800 rounded-lg appearance-none cursor-pointer accent-diamond-500"/><div className="flex gap-2 mt-2">{[2, 5, 10, 20, 50].map(l => (<button key={l} onClick={() => setLeverage(l)} className={`flex-1 py-1 text-xs rounded border transition-colors ${leverage === l ? 'bg-diamond-500/20 border-diamond-500 text-diamond-400' : 'bg-whale-800 border-whale-700 text-slate-500 hover:text-slate-300'}`}>{l}x</button>))}</div></div><div className="bg-whale-950 p-4 rounded-lg border border-whale-700 space-y-2 text-sm"><div className="flex justify-between"><span className="text-slate-500">Margin Required</span><span className="text-slate-200 font-mono">${marginRequired.toLocaleString(undefined, {maximumFractionDigits: 2})}</span></div><div className="flex justify-between"><span className="text-slate-500">Est. Liquidation</span><span className="text-trenchGold-500 font-mono">${liquidationPrice.toLocaleString(undefined, {maximumFractionDigits: 2})}</span></div><div className="flex justify-between border-t border-whale-800 pt-2 mt-2"><span className="text-slate-500">Execution Price</span><span className="text-white font-mono font-bold">${currentPrice.toLocaleString()}</span></div></div><div className="flex gap-2 items-start bg-rose-900/10 p-3 rounded border border-rose-900/30"><AlertTriangle className="text-rose-500 shrink-0" size={16} /><p className="text-[10px] text-rose-400/80 leading-tight">You are about to open a {leverage}x leveraged {pendingSide} position on {lockedAsset}. Ensure you have sufficient collateral.</p></div><div className="grid grid-cols-2 gap-4"><button onClick={closeModal} className="py-3 rounded-lg font-bold text-slate-400 hover:bg-whale-800 transition-colors border border-transparent">Cancel</button><button onClick={handleExecute} className={`py-3 rounded-lg font-bold text-whale-900 shadow-lg transition-transform active:scale-95 ${pendingSide === 'LONG' ? 'bg-emerald-500 hover:bg-emerald-400 shadow-emerald-500/20' : 'bg-rose-500 hover:bg-rose-400 shadow-rose-500/20'}`}>CONFIRM {pendingSide}</button></div></div></div></div>)}
    </>
  );
};
export default TradeExecution;
